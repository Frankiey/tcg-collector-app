<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Pokemon Collection</title>
  <style>
    /* Dark theme CSS Variables */
    :root {
      --bg-color: #121212;
      --card-bg: #1e1e1e;
      --card-border: #333;
      --shadow-color: rgba(0, 0, 0, 0.6);
      --font-color: #e0e0e0;
      --primary-color: #b3401e;
      --primary-hover: #9b2502;
      --bought-bg: #2e7d32;
      --success-color: #66bb6a;
      --header-bg: linear-gradient(135deg, #424242, #212121);
    }

    /* Global Styles */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--bg-color);
      margin: 0;
      padding: 0;
      color: var(--font-color);
    }
    
    header {
      background: var(--header-bg);
      padding: 2rem 1rem 1.5rem;
      margin-bottom: 1rem;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      color: white;
      text-align: center;
    }
    
    h1 {
      margin: 0 0 1.2rem;
      font-size: 2.5rem;
      text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
    }

    /* Tabs Styles */
    .tabs {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
      max-width: 800px; /* Adjust the max-width as needed */
      margin: 0 auto;   /* Centers the tabs container */
      flex-wrap: wrap;
    }
    .tabs button {
      background: var(--card-bg);
      border: 1px solid #444;
      color: var(--font-color);
      padding: 0.5rem 1rem;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.2s;
      flex: 1 1 auto;
      min-width: 100px;
      margin: 0.2rem;

    }
    .tabs button.active {
      background: var(--primary-color);
      color: #fff;
    }

    /* Refresh Button */
    #refresh-btn {
      padding: 0.5rem 1rem;
      background: var(--primary-color);
      border: none;
      border-radius: 25px;
      color: #fff;
      cursor: pointer;
      margin-top: 1rem;
      transition: background 0.2s;
    }
    #refresh-btn:hover {
      background: var(--primary-hover);
    }
    
    .search-controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 0.5rem;
      margin: 0 auto;
      max-width: 800px;
    }
    
    .search-controls input,
    .search-controls select {
      padding: 0.7rem 1rem;
      border-radius: 25px;
      border: 1px solid #444;
      font-size: 1rem;
      background: #2a2a2a;
      color: var(--font-color);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      outline: none;
      flex-grow: 1;
      max-width: 300px;
    }
    
    .search-controls input:focus,
    .search-controls select:focus {
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
    }
    
    .search-controls label {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      font-size: 1rem;
      color: var(--font-color);
    }
    
    /* Advanced Filters: Only printing year and foil checkbox */
    .advanced-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      justify-content: center;
      margin-top: 1rem;
    }
    .advanced-filters input {
      padding: 0.7rem 1rem;
      border-radius: 25px;
      border: 1px solid #444;
      max-width: 200px;
      background: #2a2a2a;
      color: var(--font-color);
    }
    .advanced-filters label {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      color: #ccc;
      font-size: 0.95rem;
    }

    /* Collection Summary */
    #collection-summary {
      text-align: center;
      padding: 1rem;
      color: #ccc;
      font-size: 1rem;
    }

    /* Loading Indicator */
    #loading-indicator {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1500;
      align-items: center;
      justify-content: center;
    }
    .spinner {
      border: 8px solid #f3f3f3;
      border-top: 8px solid var(--primary-color);
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Cards Grid */
    #cards-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 1.5rem;
      padding: 0 1rem 2rem;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .card {
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 4px 12px var(--shadow-color);
      padding: 1rem;
      text-align: center;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      cursor: pointer;
    }
    
    .card:hover {
      transform: translateY(-8px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
    }
    
    .card.bought {
      background-color: var(--bought-bg);
    }
    
    .card img {
      width: 100%;
      height: auto;
      border-radius: 8px;
      transition: transform 0.5s ease;
    }
    
    .card:hover img {
      transform: scale(1.05);
    }
    
    .card .title {
      margin: 1rem 0 0.4rem;
      font-weight: bold;
      color: var(--font-color);
      font-size: 1.2rem;
    }
    
    .card .info {
      font-size: 0.9rem;
      color: #aaa;
      margin-bottom: 0.8rem;
      line-height: 1.4;
    }
    
    .card-actions {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 1rem;
    }
    
    .bought-wrapper {
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }
    
    .bought-wrapper input[type='checkbox'] {
      appearance: none;
      -webkit-appearance: none;
      width: 1.2rem;
      height: 1.2rem;
      border: 2px solid #555;
      border-radius: 4px;
      background-color: #1e1e1e;
      cursor: pointer;
      position: relative;
      transition: all 0.2s;
    }
    
    .bought-wrapper input[type='checkbox']:checked {
      background-color: var(--success-color);
      border-color: var(--success-color);
    }
    
    .bought-wrapper input[type='checkbox']:checked::after {
      content: '✓';
      color: white;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 0.8rem;
    }
    
    .bought-wrapper label {
      font-size: 0.95rem;
      color: #ccc;
      cursor: pointer;
    }

    /* Favorite Star */
    .favorite-star {
      cursor: pointer;
      font-size: 1.5rem;
      color: #555;
      transition: color 0.2s;
      margin-left: 0.5rem;
    }
    .favorite-star.favorited {
      color: gold;
    }

    /* External Link Button */
    .external-link-btn {
      display: inline-block;
      margin-top: 0.5rem;
      padding: 0.5rem 1rem;
      background: var(--primary-color);
      color: #fff;
      text-decoration: none;
      border-radius: 25px;
      font-size: 0.9rem;
      transition: background 0.2s, transform 0.1s;
    }
    .external-link-btn:hover {
      background: var(--primary-hover);
      transform: translateY(-1px);
    }
    .external-link-btn:active {
      transform: translateY(1px);
    }

    /* Modal Styles */
    #modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(5px);
      transition: all 0.3s ease;
    }
    
    #modal .modal-content {
      background-color: var(--card-bg);
      margin: 5% auto;
      padding: 2rem;
      border-radius: 16px;
      width: 90%;
      max-width: 700px;
      position: relative;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
      animation: modalIn 0.4s ease;
      color: var(--font-color);
    }
    
    @keyframes modalIn {
      from {
        opacity: 0;
        transform: translateY(-30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* Improved Close Button */
    #modal .close {
      color: #fff;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 50%;
      padding: 5px 10px;
      position: absolute;
      top: 15px;
      right: 20px;
      font-size: 32px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s, transform 0.2s;
      z-index: 10;
    }
    
    #modal .close:hover {
      background: var(--primary-hover);
      transform: scale(1.1);
    }
    
    #modal-body {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
    }
    
    #modal .modal-image {
      grid-column: 1;
      justify-self: center;
    }
    
    #modal .modal-details {
      grid-column: 2;
    }
    
    #modal img {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
    }
    
    #modal h2 {
      color: var(--primary-color);
      margin-top: 0;
      font-size: 1.8rem;
      border-bottom: 2px solid #333;
      padding-bottom: 0.5rem;
    }
    
    #modal .info-section {
      margin-bottom: 1.5rem;
    }
    
    #modal .info-section h3 {
      margin-bottom: 0.5rem;
      color: #ccc;
      font-size: 1.2rem;
    }
    
    #modal p {
      font-size: 1rem;
      color: var(--font-color);
      line-height: 1.5;
      margin: 0.7rem 0;
    }
    
    #modal .price-block {
      background-color: #2a2a2a;
      padding: 0.8rem;
      border-radius: 8px;
      margin-bottom: 1rem;
    }
    
    #modal .price-title {
      font-weight: bold;
      color: #ccc;
      margin-bottom: 0.5rem;
    }
    
    #modal .price-detail {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    
    #modal .price-item {
      background: #333;
      padding: 0.5rem;
      border-radius: 5px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
      flex: 1;
      min-width: 80px;
      text-align: center;
    }
    
    #modal .price-label {
      font-size: 0.8rem;
      color: #bbb;
    }
    
    #modal .price-value {
      font-weight: bold;
      color: var(--primary-color);
    }
    
    #modal textarea {
      width: 100%;
      height: 80px;
      margin: 0.5rem 0 1rem;
      font-size: 0.95rem;
      padding: 0.8rem;
      border: 1px solid #444;
      border-radius: 8px;
      resize: vertical;
      font-family: inherit;
      background: #2a2a2a;
      color: var(--font-color);
      transition: border 0.2s;
    }
    
    #modal textarea:focus {
      border-color: var(--primary-color);
      outline: none;
    }
    
    #modal button.save-note {
      padding: 0.7rem 1.5rem;
      font-size: 1rem;
      background-color: var(--success-color);
      color: #fff;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      transition: background-color 0.2s, transform 0.1s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    
    #modal button.save-note:hover {
      background-color: #4caf50;
      transform: translateY(-1px);
    }
    
    #modal button.save-note:active {
      transform: translateY(1px);
    }
    
    /* Responsive Adjustments */
    @media (max-width: 768px) {
      h1 {
        font-size: 2rem;
      }
      
      #modal-body {
        grid-template-columns: 1fr;
      }
      
      #modal .modal-image,
      #modal .modal-details {
        grid-column: 1;
      }
      
      #modal .modal-content {
        padding: 1.5rem;
        margin: 10% auto;
      }
      
      .search-controls input,
      .search-controls select {
        max-width: none;
        width: 100%;
      }
    }
    
    @media (max-width: 480px) {
      .card {
        padding: 0.8rem;
      }
      
      h1 {
        font-size: 1.8rem;
      }
      
      header {
        padding: 1.5rem 1rem 1.2rem;
      }
      
      #cards-container {
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      }
    }
  </style>
</head>
<body>
  <!-- Loading Indicator -->
  <div id="loading-indicator">
    <div class="spinner"></div>
  </div>
  
  <header>
    <div class="header-content">
      <h1>The Pokemon Collection</h1>
      <!-- Tabs for each Pokemon -->
      <div class="tabs">
        <button class="tab active" data-collection="charizard">Charizard</button>
        <button class="tab" data-collection="cubone">Cubone</button>
        <button class="tab" data-collection="psyduck">Psyduck</button>
        <button class="tab" data-collection="pikachu">Pikachu</button>
        <button class="tab" data-collection="farfetch'd">Farfetch'd</button>
        <button class="tab" data-collection="golem">Golem</button>
      </div>
      <!-- Search and sort controls -->
      <div class="search-controls">
        <input type="text" id="search-input" placeholder="Search by name, set, rarity..." />
        <select id="filter-select">
          <option value="all">All Cards</option>
          <option value="bought">Bought</option>
          <option value="notBought">Not Bought</option>
          <option value="favorites">Favorites</option>
        </select>
        <select id="sort-select">
          <option value="name">Sort by Name (A-Z)</option>
          <option value="set">Sort by Set (A-Z)</option>
          <option value="number">Sort by Card Number (Asc)</option>
          <option value="rarity">Sort by Rarity (A-Z)</option>
          <option value="printYear">Sort by Print Year</option>
        </select>
        <label>
          <input type="checkbox" id="reverse-checkbox" /> Reverse Order
        </label>
      </div>
      <!-- Advanced Filters and Refresh Button -->
      <div class="advanced-filters">
        <input type="text" id="year-input" placeholder="Filter by Printing Year" />
        <label>
          <input type="checkbox" id="foil-checkbox" /> Foil
        </label>
        <button id="refresh-btn">Get Latest Cards</button>
      </div>
    </div>
  </header>
  
  <!-- Collection Summary -->
  <div id="collection-summary"></div>
  
  <main>
    <div id="cards-container"></div>
  </main>
  
  <!-- Modal for Detailed Card Info -->
  <div id="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <div id="modal-body"></div>
    </div>
  </div>
  
  <script>
    // Global Variables
    let currentCollection = 'charizard';
    const STORAGE_KEY_BOUGHT = 'boughtCards';
    const STORAGE_KEY_NOTES = 'cardNotes';
    const STORAGE_KEY_FAVORITES = 'favoriteCards';
    let boughtCards = JSON.parse(localStorage.getItem(STORAGE_KEY_BOUGHT)) || {};
    let cardNotes = JSON.parse(localStorage.getItem(STORAGE_KEY_NOTES)) || {};
    let favoriteCards = JSON.parse(localStorage.getItem(STORAGE_KEY_FAVORITES)) || {};
    let allCards = [];

    // Helper: save to localStorage
    const saveToLocalStorage = (key, data) => {
      localStorage.setItem(key, JSON.stringify(data));
    };

    // Format price
    const formatPrice = (price) => {
      return price ? `$${parseFloat(price).toFixed(2)}` : 'N/A';
    };

    // Create a card element for the grid
    const createCardElement = (card) => {
      const cardDiv = document.createElement('div');
      cardDiv.classList.add('card');
      if (boughtCards[card.id]) cardDiv.classList.add('bought');

      // Card image
      const img = document.createElement('img');
      img.src = card.images.small;
      img.alt = card.name;
      cardDiv.appendChild(img);

      // Title
      const title = document.createElement('div');
      title.className = 'title';
      title.textContent = card.name;
      cardDiv.appendChild(title);

      // Info: number, set, rarity, and printing year
      const info = document.createElement('div');
      info.className = 'info';
      const releaseYear = card.set && card.set.releaseDate ? card.set.releaseDate.split('/')[0] : '';
      const details = [
        card.number ? `No. ${card.number}` : '',
        card.set?.name ? `Set: ${card.set.name}` : '',
        card.rarity ? `Rarity: ${card.rarity}` : '',
        releaseYear ? `Year: ${releaseYear}` : ''
      ].filter(Boolean).join(' • ');
      info.textContent = details;
      cardDiv.appendChild(info);

      // Card actions
      const cardActions = document.createElement('div');
      cardActions.className = 'card-actions';

      // Bought checkbox and label
      const boughtWrapper = document.createElement('div');
      boughtWrapper.className = 'bought-wrapper';
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.id = `bought-${card.id}`;
      checkbox.checked = !!boughtCards[card.id];
      checkbox.addEventListener('change', (e) => {
        e.stopPropagation();
        boughtCards[card.id] = checkbox.checked;
        saveToLocalStorage(STORAGE_KEY_BOUGHT, boughtCards);
        cardDiv.classList.toggle('bought', checkbox.checked);
        renderCards();
      });
      boughtWrapper.appendChild(checkbox);
      
      const label = document.createElement('label');
      label.htmlFor = `bought-${card.id}`;
      label.textContent = 'Bought';
      label.addEventListener('click', (e) => e.stopPropagation());
      boughtWrapper.appendChild(label);
      cardActions.appendChild(boughtWrapper);

      // Favorite star icon
      const favoriteStar = document.createElement('span');
      favoriteStar.className = 'favorite-star';
      favoriteStar.innerHTML = '★';
      if (favoriteCards[card.id]) {
        favoriteStar.classList.add('favorited');
      }
      favoriteStar.addEventListener('click', (e) => {
        e.stopPropagation();
        if (favoriteCards[card.id]) {
          delete favoriteCards[card.id];
          favoriteStar.classList.remove('favorited');
        } else {
          favoriteCards[card.id] = true;
          favoriteStar.classList.add('favorited');
        }
        localStorage.setItem(STORAGE_KEY_FAVORITES, JSON.stringify(favoriteCards));
      });
      cardActions.appendChild(favoriteStar);

      cardDiv.appendChild(cardActions);

      // Make card clickable (ignoring control clicks)
      cardDiv.addEventListener('click', (e) => {
        const isControlClick = e.target.type === 'checkbox' || 
                               e.target.tagName === 'LABEL' ||
                               e.target.classList.contains('favorite-star');
        if (!isControlClick) openModal(card);
      });

      return cardDiv;
    };

    // Update collection summary
    function updateCollectionSummary() {
      const total = allCards.length;
      const boughtCount = Object.keys(boughtCards).filter(id => boughtCards[id]).length;
      const favoriteCount = Object.keys(favoriteCards).filter(id => favoriteCards[id]).length;
      const summaryDiv = document.getElementById('collection-summary');
      summaryDiv.innerHTML = `Total Cards: ${total} | Bought: ${boughtCount} | Favorites: ${favoriteCount}`;
    }

    // Render cards with filtering and sorting
    const renderCards = () => {
      const searchQuery = document.getElementById('search-input').value.toLowerCase();
      const filterValue = document.getElementById('filter-select').value;
      const sortValue = document.getElementById('sort-select').value;
      const yearFilter = document.getElementById('year-input').value.toLowerCase();
      const foilFilter = document.getElementById('foil-checkbox').checked;
      
      const cardsContainer = document.getElementById('cards-container');
      cardsContainer.innerHTML = '';

      let filteredCards = allCards.filter((card) => {
        const matchesSearch =
          (card.name && card.name.toLowerCase().includes(searchQuery)) ||
          (card.set?.name && card.set.name.toLowerCase().includes(searchQuery)) ||
          (card.number && card.number.toString().includes(searchQuery)) ||
          (card.rarity && card.rarity.toLowerCase().includes(searchQuery));
        if (!matchesSearch) return false;
        
        const releaseYear = card.set && card.set.releaseDate ? card.set.releaseDate.split('/')[0] : '';
        if (yearFilter && (!releaseYear || !releaseYear.toLowerCase().includes(yearFilter))) {
          return false;
        }
        if (foilFilter && (!card.rarity || !card.rarity.toLowerCase().includes('holo'))) {
          return false;
        }
        
        if (filterValue === 'bought' && !boughtCards[card.id]) return false;
        if (filterValue === 'notBought' && boughtCards[card.id]) return false;
        if (filterValue === 'favorites' && !favoriteCards[card.id]) return false;
        return true;
      });

      // Sorting
      filteredCards.sort((a, b) => {
        switch (sortValue) {
          case 'name':
            return a.name.localeCompare(b.name);
          case 'set':
            return (a.set?.name || '').localeCompare(b.set?.name || '');
          case 'number':
            return (parseInt(a.number) || 0) - (parseInt(b.number) || 0);
          case 'rarity':
            return (a.rarity || '').localeCompare(b.rarity || '');
          case 'printYear': {
            const yearA = parseInt(a.set?.releaseDate ? a.set.releaseDate.split('/')[0] : '0', 10);
            const yearB = parseInt(b.set?.releaseDate ? b.set.releaseDate.split('/')[0] : '0', 10);
            return yearA - yearB;
          }
          default:
            return 0;
        }
      });

      // Reverse sort order if checkbox is checked
      if (document.getElementById('reverse-checkbox').checked) {
        filteredCards.reverse();
      }

      if (filteredCards.length === 0) {
        const noResults = document.createElement('div');
        noResults.textContent = 'No cards found. Try different search criteria.';
        noResults.style.textAlign = 'center';
        noResults.style.gridColumn = '1 / -1';
        noResults.style.padding = '2rem';
        noResults.style.color = '#aaa';
        cardsContainer.appendChild(noResults);
        updateCollectionSummary();
        return;
      }

      filteredCards.forEach((card) => {
        cardsContainer.appendChild(createCardElement(card));
      });
      updateCollectionSummary();
    };

    // Modal functionality
    const modal = document.getElementById('modal');
    const modalBody = document.getElementById('modal-body');
    const closeModalBtn = document.querySelector('#modal .close');

    const closeModal = () => {
      modal.style.display = 'none';
      document.body.style.overflow = 'auto';
    };

    closeModalBtn.addEventListener('click', closeModal);
    window.addEventListener('click', (event) => {
      if (event.target === modal) closeModal();
    });
    window.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && modal.style.display === 'block') closeModal();
    });

    // Open modal to show detailed card info
    const openModal = (card) => {
      modalBody.innerHTML = '';
      document.body.style.overflow = 'hidden';

      const imageSection = document.createElement('div');
      imageSection.className = 'modal-image';
      const img = document.createElement('img');
      img.src = card.images.large || card.images.small;
      img.alt = card.name;
      imageSection.appendChild(img);
      
      const detailsSection = document.createElement('div');
      detailsSection.className = 'modal-details';
      
      const title = document.createElement('h2');
      title.textContent = card.name;
      detailsSection.appendChild(title);

      const basicInfoSection = document.createElement('div');
      basicInfoSection.className = 'info-section';
      const basicInfoTitle = document.createElement('h3');
      basicInfoTitle.textContent = 'Card Information';
      basicInfoSection.appendChild(basicInfoTitle);
      const releaseYear = card.set && card.set.releaseDate ? card.set.releaseDate.split('/')[0] : 'N/A';
      const infoPara = document.createElement('p');
      infoPara.innerHTML = `
        <strong>Number:</strong> ${card.number || 'N/A'}<br>
        <strong>Set:</strong> ${card.set?.name || 'N/A'}<br>
        <strong>Rarity:</strong> ${card.rarity || 'N/A'}<br>
        <strong>Printing Year:</strong> ${releaseYear}<br>
        <strong>Types:</strong> ${(card.types || []).join(', ') || 'N/A'}<br>
        ${card.hp ? `<strong>HP:</strong> ${card.hp}<br>` : ''}
        ${card.artist ? `<strong>Artist:</strong> ${card.artist}` : ''}
      `;
      basicInfoSection.appendChild(infoPara);
      detailsSection.appendChild(basicInfoSection);

      const pricingSection = document.createElement('div');
      pricingSection.className = 'info-section';
      const pricingTitle = document.createElement('h3');
      pricingTitle.textContent = 'Pricing Information';
      pricingSection.appendChild(pricingTitle);

      if (card.tcgplayer?.prices) {
        const priceType = Object.keys(card.tcgplayer.prices)[0];
        if (priceType && card.tcgplayer.prices[priceType]) {
          const priceData = card.tcgplayer.prices[priceType];
          const tcgPriceBlock = document.createElement('div');
          tcgPriceBlock.className = 'price-block';
          const tcgPriceTitle = document.createElement('div');
          tcgPriceTitle.className = 'price-title';
          tcgPriceTitle.textContent = `TCGplayer (${priceType.charAt(0).toUpperCase() + priceType.slice(1)})`;
          tcgPriceBlock.appendChild(tcgPriceTitle);
          const tcgPriceDetail = document.createElement('div');
          tcgPriceDetail.className = 'price-detail';
          const priceItems = [
            { label: 'Low', value: formatPrice(priceData.low) },
            { label: 'Mid', value: formatPrice(priceData.mid) },
            { label: 'High', value: formatPrice(priceData.high) },
            { label: 'Market', value: formatPrice(priceData.market) }
          ];
          priceItems.forEach(item => {
            const priceItem = document.createElement('div');
            priceItem.className = 'price-item';
            const priceLabel = document.createElement('div');
            priceLabel.className = 'price-label';
            priceLabel.textContent = item.label;
            priceItem.appendChild(priceLabel);
            const priceValue = document.createElement('div');
            priceValue.className = 'price-value';
            priceValue.textContent = item.value;
            priceItem.appendChild(priceValue);
            tcgPriceDetail.appendChild(priceItem);
          });
          tcgPriceBlock.appendChild(tcgPriceDetail);

          const tcgLink = document.createElement('a');
          tcgLink.className = 'external-link-btn';
          tcgLink.href = card.tcgplayer.url || 'https://www.tcgplayer.com';
          tcgLink.target = '_blank';
          tcgLink.rel = 'noopener noreferrer';
          tcgLink.textContent = 'View on TCGplayer';
          tcgPriceBlock.appendChild(tcgLink);

          pricingSection.appendChild(tcgPriceBlock);
        }
      }

      if (card.cardmarket?.prices) {
        const cmPrices = card.cardmarket.prices;
        const cmPriceBlock = document.createElement('div');
        cmPriceBlock.className = 'price-block';
        const cmPriceTitle = document.createElement('div');
        cmPriceTitle.className = 'price-title';
        cmPriceTitle.textContent = 'Cardmarket';
        cmPriceBlock.appendChild(cmPriceTitle);
        const cmPriceDetail = document.createElement('div');
        cmPriceDetail.className = 'price-detail';
        const priceItems = [
          { label: 'Avg Sell', value: formatPrice(cmPrices.averageSellPrice) },
          { label: 'Low', value: formatPrice(cmPrices.lowPrice) },
          { label: 'Trend', value: formatPrice(cmPrices.trendPrice) },
          { label: '30d Avg', value: formatPrice(cmPrices.avg30) }
        ];
        priceItems.forEach(item => {
          const priceItem = document.createElement('div');
          priceItem.className = 'price-item';
          const priceLabel = document.createElement('div');
          priceLabel.className = 'price-label';
          priceLabel.textContent = item.label;
          priceItem.appendChild(priceLabel);
          const priceValue = document.createElement('div');
          priceValue.className = 'price-value';
          priceValue.textContent = item.value;
          priceItem.appendChild(priceValue);
          cmPriceDetail.appendChild(priceItem);
        });
        cmPriceBlock.appendChild(cmPriceDetail);

        const cmLink = document.createElement('a');
        cmLink.className = 'external-link-btn';
        cmLink.href = card.cardmarket.url || 'https://www.cardmarket.com';
        cmLink.target = '_blank';
        cmLink.rel = 'noopener noreferrer';
        cmLink.textContent = 'View on Cardmarket';
        cmPriceBlock.appendChild(cmLink);

        pricingSection.appendChild(cmPriceBlock);
      }
      
      if (!card.tcgplayer?.prices && !card.cardmarket?.prices) {
        const noPricing = document.createElement('p');
        noPricing.textContent = 'No pricing information available for this card.';
        pricingSection.appendChild(noPricing);
      }
      
      detailsSection.appendChild(pricingSection);

      const notesSection = document.createElement('div');
      notesSection.className = 'info-section';
      const notesTitle = document.createElement('h3');
      notesTitle.textContent = 'Personal Notes';
      notesSection.appendChild(notesTitle);
      const noteTextarea = document.createElement('textarea');
      noteTextarea.placeholder = "Add your notes about this card here...";
      noteTextarea.value = cardNotes[card.id] || '';
      notesSection.appendChild(noteTextarea);
      const saveNoteBtn = document.createElement('button');
      saveNoteBtn.className = 'save-note';
      saveNoteBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg> Save Note';
      saveNoteBtn.addEventListener('click', () => {
        cardNotes[card.id] = noteTextarea.value;
        saveToLocalStorage(STORAGE_KEY_NOTES, cardNotes);
        saveNoteBtn.textContent = 'Saved!';
        setTimeout(() => {
          saveNoteBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg> Save Note';
        }, 1500);
      });
      notesSection.appendChild(saveNoteBtn);
      detailsSection.appendChild(notesSection);

      modalBody.appendChild(imageSection);
      modalBody.appendChild(detailsSection);

      modal.style.display = 'block';
    };

    // Load cards with caching (cache expires after 1 day)
    const loadCards = async () => {
      const loadingIndicator = document.getElementById('loading-indicator');
      loadingIndicator.style.display = 'flex';
      const cacheKey = 'cachedCards_' + currentCollection;
      const cacheTimestampKey = 'cacheTimestamp_' + currentCollection;
      const now = Date.now();
      const oneDay = 24 * 60 * 60 * 1000;
      const cachedData = localStorage.getItem(cacheKey);
      const cachedTimestamp = localStorage.getItem(cacheTimestampKey);

      if (cachedData && cachedTimestamp && (now - parseInt(cachedTimestamp)) < oneDay) {
        allCards = JSON.parse(cachedData);
        renderCards();
        loadingIndicator.style.display = 'none';
        return;
      }

      const query = 'name:' + currentCollection;
      try {
        const response = await fetch(
          'https://api.pokemontcg.io/v2/cards?q=' + encodeURIComponent(query)
        );
        const { data } = await response.json();
        allCards = data;
        renderCards();
        localStorage.setItem(cacheKey, JSON.stringify(allCards));
        localStorage.setItem(cacheTimestampKey, now);
      } catch (error) {
        console.error('Error fetching cards:', error);
        const cached = localStorage.getItem(cacheKey);
        if (cached) {
          allCards = JSON.parse(cached);
          renderCards();
        } else {
          const cardsContainer = document.getElementById('cards-container');
          cardsContainer.innerHTML = '<div style="text-align: center; grid-column: 1/-1; padding: 2rem;">Failed to load cards. Please check your internet connection and try again.</div>';
        }
      } finally {
        loadingIndicator.style.display = 'none';
      }
    };

    // Tab functionality for each Pokemon
    const tabs = document.querySelectorAll('.tabs .tab');
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentCollection = tab.getAttribute('data-collection');
        loadCards();
      });
    });

    // Refresh button functionality to clear cache and get latest cards
    document.getElementById('refresh-btn').addEventListener('click', () => {
      const cacheKey = 'cachedCards_' + currentCollection;
      const cacheTimestampKey = 'cacheTimestamp_' + currentCollection;
      localStorage.removeItem(cacheKey);
      localStorage.removeItem(cacheTimestampKey);
      loadCards();
    });

    // Event listeners for filter inputs
    document.getElementById('search-input').addEventListener('input', renderCards);
    document.getElementById('filter-select').addEventListener('change', renderCards);
    document.getElementById('sort-select').addEventListener('change', renderCards);
    document.getElementById('reverse-checkbox').addEventListener('change', renderCards);
    document.getElementById('year-input').addEventListener('input', renderCards);
    document.getElementById('foil-checkbox').addEventListener('change', renderCards);

    window.addEventListener('DOMContentLoaded', loadCards);
  </script>
</body>
</html>
